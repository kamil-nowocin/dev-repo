name: TEST | Deploy and Trigger Tests

on:
  workflow_dispatch: {}  # Manual trigger remains available.
  pull_request:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  parse-command:
    name: "Parse /run-tests Command"
    # Only run this job if the event is not an issue_comment OR if it is and the comment starts with /run-tests.
    if: github.event_name != 'issue_comment' || startsWith(github.event.comment.body, '/run-tests')
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      env: ${{ steps.set-params.outputs.env }}
      module: ${{ steps.set-params.outputs.module }}
      group: ${{ steps.set-params.outputs.group }}
      enablePKCE: ${{ steps.set-params.outputs.enablePKCE }}
      enableTestRetry: ${{ steps.set-params.outputs.enableTestRetry }}
      enableXrayReport: ${{ steps.set-params.outputs.enableXrayReport }}
      enableSlackReport: ${{ steps.set-params.outputs.enableSlackReport }}
    steps:
      - name: Parse parameters from comment or use defaults
        id: set-params
        shell: bash
        run: |
          # Define default values (used for non-issue_comment events)
          DEFAULT_ENV="UAT (PROD-1)"
          DEFAULT_MODULE="Websters"
          DEFAULT_GROUP="REGRESSION"
          DEFAULT_BOOL="false"

          # For issue_comment events, capture the issue number into a shell variable.
          if [ "${GITHUB_EVENT_NAME}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          if [ "${GITHUB_EVENT_NAME}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            # Ensure the comment starts with /run-tests (job-level if already ensures this, but we double-check)
            if [[ "$COMMENT" != /run-tests* ]]; then
              echo "Comment does not start with /run-tests. Using default values."
              ENV_TOKEN=$DEFAULT_ENV
              MODULE_TOKEN=$DEFAULT_MODULE
              GROUP_TOKEN=$DEFAULT_GROUP
              PKCE_TOKEN=$DEFAULT_BOOL
              TESTRETRY_TOKEN=$DEFAULT_BOOL
              XRAY_TOKEN=$DEFAULT_BOOL
              SLACK_TOKEN=$DEFAULT_BOOL
            else
              # Split the comment into tokens.
              # Expected total tokens: 8 (command + 7 parameters)
              set -- $COMMENT
              if [ "$#" -ne 8 ]; then
                ERROR_MSG="/run-tests <env> <module> <group> <enablePKCE> <enableTestRetry> <enableXrayReport> <enableSlackReport>"
                echo "Invalid command format. Expected: ${ERROR_MSG}"
                curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" \
                  --request POST \
                  --data "{\"body\": \"Invalid command format. Expected: ${ERROR_MSG}\"}" \
                  "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments"
                exit 1
              fi

              CMD=$1
              if [ "$CMD" != "/run-tests" ]; then
                ERROR_MSG="Invalid command. The command must start with '/run-tests'."
                echo "$ERROR_MSG"
                curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" \
                  --request POST \
                  --data "{\"body\": \"${ERROR_MSG}\"}" \
                  "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments"
                exit 1
              fi

              # Now assign tokens. All are required.
              ENV_TOKEN=$2
              MODULE_TOKEN=$3
              GROUP_TOKEN=$4
              PKCE_TOKEN=$5
              TESTRETRY_TOKEN=$6
              XRAY_TOKEN=$7
              SLACK_TOKEN=$8

              # Validate that the boolean tokens are either "true" or "false"
              for VALUE in "$PKCE_TOKEN" "$TESTRETRY_TOKEN" "$XRAY_TOKEN" "$SLACK_TOKEN"; do
                if [ "$VALUE" != "true" ] && [ "$VALUE" != "false" ]; then
                  ERROR_MSG="Invalid boolean value detected. Expected 'true' or 'false', got '$VALUE'."
                  echo "$ERROR_MSG"
                  curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" \
                    --request POST \
                    --data "{\"body\": \"${ERROR_MSG}\"}" \
                    "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments"
                  exit 1
                fi
              done
              echo "Using values from comment: ENV='$ENV_TOKEN', MODULE='$MODULE_TOKEN', GROUP='$GROUP_TOKEN', enablePKCE='$PKCE_TOKEN', enableTestRetry='$TESTRETRY_TOKEN', enableXrayReport='$XRAY_TOKEN', enableSlackReport='$SLACK_TOKEN'"
            fi
          else
            # For workflow_dispatch or pull_request events, use default values.
            ENV_TOKEN=$DEFAULT_ENV
            MODULE_TOKEN=$DEFAULT_MODULE
            GROUP_TOKEN=$DEFAULT_GROUP
            PKCE_TOKEN=$DEFAULT_BOOL
            TESTRETRY_TOKEN=$DEFAULT_BOOL
            XRAY_TOKEN=$DEFAULT_BOOL
            SLACK_TOKEN=$DEFAULT_BOOL
            echo "Using default values: ENV='$ENV_TOKEN', MODULE='$MODULE_TOKEN', GROUP='$GROUP_TOKEN', enablePKCE='$PKCE_TOKEN', enableTestRetry='$TESTRETRY_TOKEN', enableXrayReport='$XRAY_TOKEN', enableSlackReport='$SLACK_TOKEN'"
          fi

          echo "env=$ENV_TOKEN" >> $GITHUB_OUTPUT
          echo "module=$MODULE_TOKEN" >> $GITHUB_OUTPUT
          echo "group=$GROUP_TOKEN" >> $GITHUB_OUTPUT
          echo "enablePKCE=$PKCE_TOKEN" >> $GITHUB_OUTPUT
          echo "enableTestRetry=$TESTRETRY_TOKEN" >> $GITHUB_OUTPUT
          echo "enableXrayReport=$XRAY_TOKEN" >> $GITHUB_OUTPUT
          echo "enableSlackReport=$SLACK_TOKEN" >> $GITHUB_OUTPUT

  run-regression-tests:
    name: "Build & Execute Tests ðŸ› ï¸"
    needs: parse-command
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       github.event.action == 'labeled' &&
       github.event.label.name == 'deploy-with-tests') ||
      (github.event_name == 'issue_comment' &&
       startsWith(github.event.comment.body, '/run-tests'))
    uses: "kamil-nowocin/test-repo/.github/workflows/dev-run-tests-workflow.yaml@main"
    with:
      testModule: ${{ needs.parse-command.outputs.module }}
      testEnvironment: ${{ needs.parse-command.outputs.env }}
      testGroup: ${{ needs.parse-command.outputs.group }}
      enablePKCE: ${{ needs.parse-command.outputs.enablePKCE }}
      enableTestRetry: ${{ needs.parse-command.outputs.enableTestRetry }}
      enableXrayReport: ${{ needs.parse-command.outputs.enableXrayReport }}
      enableSlackReport: ${{ needs.parse-command.outputs.enableSlackReport }}
      triggeredFromDevRepo: true
    secrets:
      XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
      XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
      SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
      MY_GITHUB_SECRET: ${{ secrets.MY_GITHUB_SECRET }}
